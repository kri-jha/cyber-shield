<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tickets - CyberShield</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="utils/dataManager.js"></script>
</head>
<body>
    <!-- Include Navbar -->
    <div id="navbar-container"></div>

    <script>
    // Load navbar content
    fetch('navbar.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById('navbar-container').innerHTML = html;
        })
        .catch(error => console.error('Error loading navbar:', error));
    </script>

    <div class="container" style="margin-top: 100px; padding: 20px;">
        <h1><i class="fas fa-ticket-alt"></i> My Tickets</h1>
        
        <div id="myTicketsContainer" style="margin-top: 30px;">
            <div class="loading" id="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading your tickets...
            </div>
        </div>
    </div>

    <script>
        async function loadMyTickets() {
            const container = document.getElementById('myTicketsContainer');
            const currentUser = JSON.parse(localStorage.getItem('current_user') || 'null');
            
            if (!currentUser) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <i class="fas fa-user-slash" style="font-size: 48px; color: var(--gray-light); margin-bottom: 20px;"></i>
                        <h3>Not Logged In</h3>
                        <p>Please login to view your tickets</p>
                        <button class="btn btn-primary" onclick="window.location.href='index.html'">
                            <i class="fas fa-sign-in-alt"></i> Go to Login
                        </button>
                    </div>
                `;
                return;
            }
            
            try {
                const result = await dataManager.getAllTickets();
                if (result.success) {
                    const userTickets = result.tickets.filter(ticket => ticket.userId === currentUser.id);
                    
                    if (userTickets.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 50px;">
                                <i class="fas fa-inbox" style="font-size: 48px; color: var(--gray-light); margin-bottom: 20px;"></i>
                                <h3>No Tickets Yet</h3>
                                <p>You haven't created any tickets yet</p>
                                <a href="create.html" class="btn btn-primary">
                                    <i class="fas fa-plus-circle"></i> Create First Ticket
                                </a>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <span>${userTickets.length} tickets found</span>
                                <div>
                                    <button class="btn btn-secondary btn-small" onclick="filterTickets('all')">All</button>
                                    <button class="btn btn-secondary btn-small" onclick="filterTickets('open')">Open</button>
                                    <button class="btn btn-secondary btn-small" onclick="filterTickets('resolved')">Resolved</button>
                                </div>
                            </div>
                            <div id="ticketsList"></div>
                        `;
                        
                        displayTickets(userTickets);
                    }
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                container.innerHTML = '<p class="error">Error loading tickets. Please try again.</p>';
            }
        }
        
        function displayTickets(tickets) {
            const container = document.getElementById('ticketsList');
            container.innerHTML = '';
            
            tickets.forEach(ticket => {
                const statusColors = {
                    'open': '#3b82f6',
                    'assigned': '#f59e0b',
                    'in-progress': '#8b5cf6',
                    'resolved': '#10b981'
                };
                
                const ticketHTML = `
                    <div class="ticket-card" style="background: var(--dark-light); border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 5px solid ${statusColors[ticket.status] || '#6b7280'};">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 style="margin: 0 0 10px 0;">${ticket.title}</h3>
                                <div style="display: flex; gap: 15px; font-size: 14px; color: var(--gray-light); margin-bottom: 10px;">
                                    <span><i class="fas fa-tag"></i> ${ticket.category}</span>
                                    <span><i class="fas fa-fire"></i> ${ticket.severity}</span>
                                    <span><i class="fas fa-calendar"></i> ${new Date(ticket.createdAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div>
                                <span class="status-badge" style="background: ${statusColors[ticket.status] || '#6b7280'}20; color: ${statusColors[ticket.status] || '#6b7280'}; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    ${ticket.status.toUpperCase()}
                                </span>
                            </div>
                        </div>
                        
                        <p style="color: var(--gray-light); margin-bottom: 15px;">${ticket.description.substring(0, 150)}...</p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                ${ticket.assignedExpert ? `
                                    <span style="font-size: 14px;"><i class="fas fa-user-shield"></i> Assigned to: ${ticket.expertName}</span>
                                ` : ''}
                            </div>
                            <div>
                                <div style="font-size: 14px; color: var(--gray-light); margin-bottom: 5px;">
                                    <i class="fas fa-chart-line"></i> Progress: ${ticket.progress}%
                                </div>
                                <div style="width: 200px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${ticket.progress}%; height: 100%; background: ${statusColors[ticket.status] || '#6b7280'};"></div>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-small" onclick="viewTicket('${ticket.id}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `;
                
                container.innerHTML += ticketHTML;
            });
        }
        
        function viewTicket(ticketId) {
            window.location.href = `ticket-detail.html?id=${ticketId}`;
        }
        
        document.addEventListener('DOMContentLoaded', loadMyTickets);
    </script>
</body>
</html>