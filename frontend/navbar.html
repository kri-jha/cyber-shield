<!-- navbar.html -->
<nav class="navbar">
    <div class="nav-container">
        <a href="index.html" class="nav-logo">
            <div class="logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="logo-text">CyberShield</div>
        </a>
        
        <div class="nav-links">
            <a href="index.html" class="nav-link" id="nav-feed">Feed</a>
            <a href="dashboard.html" class="nav-link" id="nav-dashboard">Dashboard</a>
            <a href="experts.html" class="nav-link" id="nav-experts">Experts</a>
            <a href="tools.html" class="nav-link" id="nav-tools">Tools</a>
            <a href="create.html" class="nav-link" id="nav-create">Get Help</a>
        </div>
        
        <div class="nav-actions">
            <button class="btn btn-outline btn-small" id="loginBtn">
                <i class="fas fa-user"></i> <span id="loginText">Login</span>
            </button>
            <a href="create.html" class="btn btn-primary btn-small">
                <i class="fas fa-plus"></i> New Case
            </a>
        </div>
        
        <button class="mobile-menu-btn" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
        </button>
    </div>
</nav>

<!-- Mobile Menu -->
<div class="mobile-menu" id="mobileMenu" style="display: none;">
    <div style="display: flex; flex-direction: column; gap: 15px; padding: 20px;">
        <a href="index.html" class="nav-link" onclick="toggleMenu()">Feed</a>
        <a href="dashboard.html" class="nav-link" onclick="toggleMenu()">Dashboard</a>
        <a href="experts.html" class="nav-link" onclick="toggleMenu()">Experts</a>
        <a href="tools.html" class="nav-link" onclick="toggleMenu()">Tools</a>
        <a href="create.html" class="nav-link" onclick="toggleMenu()">Get Help</a>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-outline btn-small" style="flex: 1;" onclick="showLogin(); toggleMenu();">
                <i class="fas fa-user"></i> <span id="mobileLoginText">Login</span>
            </button>
            <a href="create.html" class="btn btn-primary btn-small" style="flex: 1;" onclick="toggleMenu()">
                <i class="fas fa-plus"></i> New Case
            </a>
        </div>
    </div>
</div>

<!-- Notification -->
<div class="notification" id="notification">
    <div class="notification-content" style="display: flex; align-items: center; justify-content: space-between;">
        <span id="notificationMessage"></span>
        <button style="background: none; border: none; color: var(--white); font-size: 20px; cursor: pointer;" onclick="hideNotification()">
            &times;
        </button>
    </div>
</div>

<!-- Login Modal -->
<div class="modal" id="loginModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1002; align-items: center; justify-content: center;">
    <div style="background: var(--dark-light); border-radius: var(--radius-lg); padding: 40px; width: 90%; max-width: 400px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h3 style="margin: 0;">Login to CyberShield</h3>
            <button style="background: none; border: none; color: var(--gray-light); font-size: 24px; cursor: pointer;" onclick="hideLogin()">
                &times;
            </button>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email">
        </div>
        
        <div style="margin-bottom: 30px;">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password">
        </div>
        
        <button class="btn btn-primary" style="width: 100%;" onclick="handleLogin()">
            <i class="fas fa-sign-in-alt"></i> Login
        </button>
        
        <p style="text-align: center; margin-top: 20px; color: var(--gray-light); font-size: 14px;">
            Don't have an account? <a href="#" onclick="showRegister(); return false;" style="color: var(--primary); text-decoration: none;">Register here</a>
        </p>
    </div>
</div>

<script>
// ============== UNIVERSAL NAVBAR FUNCTIONS ==============

// Global user state that can be accessed from any page
let currentUser = window.currentUser || null;

// Initialize navbar immediately when loaded
initializeNavbar();

function initializeNavbar() {
    loadUserFromStorage();
    setActiveNavLink();
    setupNavbarEventListeners();
    
    // Listen for storage events to sync across tabs
    window.addEventListener('storage', function(e) {
        if (e.key === 'current_user') {
            loadUserFromStorage();
        }
    });
}

// Load user from localStorage
function loadUserFromStorage() {
    try {
        const userData = localStorage.getItem('current_user');
        if (userData) {
            currentUser = JSON.parse(userData);
            updateLoginButton();
        } else {
            currentUser = null;
            updateLoginButton();
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        currentUser = null;
        updateLoginButton();
    }
}

// Update login button based on user state
function updateLoginButton() {
    const loginBtn = document.getElementById('loginBtn');
    const loginText = document.getElementById('loginText');
    const mobileLoginText = document.getElementById('mobileLoginText');
    
    if (loginBtn && currentUser) {
        loginBtn.innerHTML = `<i class="fas fa-user"></i> <span id="loginText">${currentUser.username}</span>`;
        loginBtn.onclick = showUserMenu;
        
        if (mobileLoginText) {
            mobileLoginText.textContent = currentUser.username;
        }
    } else if (loginBtn) {
        loginBtn.innerHTML = '<i class="fas fa-user"></i> <span id="loginText">Login</span>';
        loginBtn.onclick = showLogin;
        
        if (mobileLoginText) {
            mobileLoginText.textContent = 'Login';
        }
    }
}

// Set active nav link based on current page
function setActiveNavLink() {
    const currentPage = window.location.pathname.split('/').pop() || 'index.html';
    
    // Remove active class from all nav links
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    // Add active class to current page
    const navId = `nav-${currentPage.replace('.html', '').replace('index', 'feed')}`;
    const activeLink = document.getElementById(navId);
    if (activeLink) {
        activeLink.classList.add('active');
    }
}

// Show user menu
function showUserMenu() {
    if (!currentUser) return;
    
    // Remove existing user menu if any
    const existingMenu = document.getElementById('userMenu');
    if (existingMenu) existingMenu.remove();
    
    const userMenu = document.createElement('div');
    userMenu.id = 'userMenu';
    userMenu.style.cssText = `
        position: fixed;
        top: 70px;
        right: 20px;
        background: var(--dark-light);
        border-radius: var(--radius-lg);
        padding: 15px;
        border: 1px solid rgba(255,255,255,0.1);
        min-width: 200px;
        box-shadow: var(--shadow-lg);
        z-index: 1001;
        animation: fadeIn 0.2s ease-out;
    `;
    
    userMenu.innerHTML = `
        <div style="padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="font-weight: 600; color: var(--white);">${currentUser.username}</div>
            <div style="font-size: 12px; color: var(--gray-light);">${currentUser.email}</div>
        </div>
        
        <div style="padding: 10px 0;">
            <button class="user-menu-item" onclick="window.location.href='dashboard.html'">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="user-menu-item" onclick="window.location.href='create.html'">
                <i class="fas fa-plus-circle"></i> New Ticket
            </button>
            <button class="user-menu-item" onclick="window.location.href='my-tickets.html'">
                <i class="fas fa-ticket-alt"></i> My Tickets
            </button>
            <button class="user-menu-item" onclick="window.location.href='saved-posts.html'">
                <i class="fas fa-bookmark"></i> Saved Posts
            </button>
        </div>
        
        <div style="padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.1);">
            <button class="user-menu-item logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    `;
    
    // Add animation style
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-menu-item {
            width: 100%;
            background: none;
            border: none;
            color: var(--gray-light);
            padding: 10px;
            text-align: left;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .user-menu-item:hover {
            background: rgba(255,255,255,0.05);
            color: var(--white);
            transform: translateX(5px);
        }
        
        .user-menu-item.logout {
            color: var(--accent);
        }
        
        .user-menu-item.logout:hover {
            background: rgba(239, 68, 68, 0.1);
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(userMenu);
    
    // Close menu when clicking outside
    setTimeout(() => {
        const closeMenu = (e) => {
            if (!userMenu.contains(e.target) && !e.target.closest('#loginBtn')) {
                userMenu.remove();
                document.removeEventListener('click', closeMenu);
            }
        };
        document.addEventListener('click', closeMenu);
    }, 100);
}

// Show login modal
function showLogin() {
    document.getElementById('loginModal').style.display = 'flex';
}

// Hide login modal
function hideLogin() {
    document.getElementById('loginModal').style.display = 'none';
}

// Handle login
async function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showNotification('Please enter both email and password', 'error');
        return;
    }
    
    try {
        const usersData = await dataManager.loadJSON('users.json');
        const user = usersData.users.find(u => u.email === email);
        
        if (user) {
            // Login successful
            currentUser = {
                id: user.id,
                username: user.username,
                email: user.email,
                role: user.role,
                joinedAt: user.createdAt
            };
            
            // Save to localStorage
            localStorage.setItem('current_user', JSON.stringify(currentUser));
            
            // Update UI immediately
            updateLoginButton();
            hideLogin();
            showNotification(`Welcome back, ${user.username}!`, 'success');
            
            // Update user's last login in the database
            user.lastLogin = new Date().toISOString();
            await dataManager.saveJSON('users.json', usersData);
            
            // Dispatch event to update other navbar instances
            window.dispatchEvent(new Event('userLoggedIn'));
            
        } else {
            if (confirm('No account found. Would you like to register?')) {
                showRegister();
            } else {
                showNotification('Login failed. Please check credentials.', 'error');
            }
        }
    } catch (error) {
        console.error('Login error:', error);
        showNotification('Login failed. Please try again.', 'error');
    }
}

// Show registration form
function showRegister() {
    hideLogin();
    
    const registerHTML = `
        <div id="registerModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1002; display: flex; align-items: center; justify-content: center;">
            <div style="background: var(--dark-light); border-radius: var(--radius-lg); padding: 40px; width: 90%; max-width: 400px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h3 style="margin: 0;">Register for CyberShield</h3>
                    <button style="background: none; border: none; color: var(--gray-light); font-size: 24px; cursor: pointer;" onclick="document.getElementById('registerModal').remove()">
                        &times;
                    </button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="regName" placeholder="Enter your full name">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="regEmail" placeholder="Enter your email">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="regPassword" placeholder="Create a password">
                </div>
                
                <div style="margin-bottom: 30px;">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="regConfirmPassword" placeholder="Confirm password">
                </div>
                
                <button class="btn btn-primary" style="width: 100%;" onclick="handleRegister()">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
                
                <p style="text-align: center; margin-top: 20px; color: var(--gray-light); font-size: 14px;">
                    Already have an account? <a href="#" onclick="document.getElementById('registerModal').remove(); showLogin(); return false;" style="color: var(--primary); text-decoration: none;">Login here</a>
                </p>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', registerHTML);
}

// Handle registration - UPDATED VERSION
async function handleRegister() {
    const name = document.getElementById('regName')?.value;
    const email = document.getElementById('regEmail')?.value;
    const password = document.getElementById('regPassword')?.value;
    const confirmPassword = document.getElementById('regConfirmPassword')?.value;
    
    if (!name || !email || !password || !confirmPassword) {
        showNotification('Please fill all fields', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 6) {
        showNotification('Password must be at least 6 characters', 'error');
        return;
    }
    
    try {
        const usersData = await dataManager.loadJSON('users.json');
        
        if (usersData.users.some(u => u.email === email)) {
            showNotification('Email already registered. Please login.', 'error');
            return;
        }
        
        const newUser = {
            id: `user_${Date.now()}`,
            username: name.replace(/\s+/g, '_').toLowerCase(),
            email: email,
            role: 'victim',
            isAnonymous: false,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString(),
            tickets: [],
            savedPosts: [],
            stats: {
                postsViewed: 0,
                ticketsCreated: 0,
                casesResolved: 0,
                postsLiked: 0,
                postsSaved: 0,
                timeSpent: "0 hours"
            }
        };
        
        usersData.users.push(newUser);
        if (!usersData.stats) usersData.stats = { totalUsers: 0, activeUsers: 0 };
        usersData.stats.totalUsers = usersData.users.length;
        usersData.lastUpdated = new Date().toISOString();
        
        await dataManager.saveJSON('users.json', usersData);
        
        // Set current user immediately
        currentUser = {
            id: newUser.id,
            username: name, // Show full name, not username with underscores
            email: newUser.email,
            role: newUser.role,
            joinedAt: newUser.createdAt
        };
        
        // Save to localStorage
        localStorage.setItem('current_user', JSON.stringify(currentUser));
        
        // Update UI immediately
        updateLoginButton();
        
        // Remove registration modal
        document.getElementById('registerModal')?.remove();
        
        showNotification(`Account created successfully! Welcome to CyberShield, ${name}!`, 'success');
        
        // Dispatch event to update navbar across all pages
        window.dispatchEvent(new Event('userRegistered'));
        
        // Refresh the page after 2 seconds to ensure all components update
        setTimeout(() => {
            location.reload();
        }, 2000);
        
    } catch (error) {
        console.error('Registration error:', error);
        showNotification(`Registration failed: ${error.message}`, 'error');
    }
}

// Logout function
function logout() {
    currentUser = null;
    localStorage.removeItem('current_user');
    updateLoginButton();
    
    // Remove user menu if open
    const userMenu = document.getElementById('userMenu');
    if (userMenu) userMenu.remove();
    
    showNotification('Logged out successfully', 'info');
    
    // Dispatch event to update other navbar instances
    window.dispatchEvent(new Event('userLoggedOut'));
    
    // Refresh to update UI
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Toggle mobile menu
function toggleMenu() {
    const menu = document.getElementById('mobileMenu');
    if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
    } else {
        menu.style.display = 'none';
    }
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    const messageElement = document.getElementById('notificationMessage');
    
    if (!notification || !messageElement) return;
    
    messageElement.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 4000);
}

// Hide notification
function hideNotification() {
    document.getElementById('notification').style.display = 'none';
}

// Setup event listeners
function setupNavbarEventListeners() {
    // Listen for user events to update navbar across pages
    window.addEventListener('userLoggedIn', updateLoginButton);
    window.addEventListener('userRegistered', updateLoginButton);
    window.addEventListener('userLoggedOut', updateLoginButton);
    
    // Close login modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('loginModal');
        if (event.target === modal) {
            hideLogin();
        }
        
        // Close mobile menu when clicking outside
        const mobileMenu = document.getElementById('mobileMenu');
        const menuBtn = document.querySelector('.mobile-menu-btn');
        if (mobileMenu && mobileMenu.style.display === 'block' && 
            !mobileMenu.contains(event.target) && 
            !menuBtn.contains(event.target)) {
            mobileMenu.style.display = 'none';
        }
    });
}

// Make functions globally available
window.showLogin = showLogin;
window.hideLogin = hideLogin;
window.handleLogin = handleLogin;
window.showRegister = showRegister;
window.handleRegister = handleRegister;
window.logout = logout;
window.toggleMenu = toggleMenu;
window.showNotification = showNotification;
window.hideNotification = hideNotification;
window.showUserMenu = showUserMenu;
</script>